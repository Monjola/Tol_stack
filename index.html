<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>StackMaster | Tolerance Analysis</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <header>
      <h1>StackMaster · Tolerance Analysis</h1>
      <div style="display: flex; gap: 0.5rem;">
        <button id="save-stack-btn" class="secondary">Save Stack</button>
        <button id="load-stack-btn" class="secondary">Load Stack</button>
        <input type="file" id="load-stack-input" accept=".json" style="display: none;">
        <button id="open-analysis-setup-dialog" class="secondary">Analysis Setup</button>
        <button id="open-settings-dialog" class="secondary">Settings</button>
        <button id="open-help-dialog" class="secondary">Help</button>
      </div>
    </header>

    <main>
      <section id="canvas-container">
        <h2>Visual Canvas</h2>
        <div class="canvas-upload-area" id="canvas-upload-area">
          <input type="file" id="drawing-upload" accept="image/*" style="display: none;">
          <div class="upload-placeholder" id="canvas-upload-placeholder">
            <p>Drop image here, paste from clipboard, or click to upload</p>
            <button type="button" class="secondary" id="canvas-upload-btn">Choose File</button>
          </div>
          <div class="canvas-wrapper" id="canvas-wrapper" style="display: none;">
            <img id="drawing-img" alt="Drawing background" />
            <canvas id="drawing-canvas"></canvas>
          </div>
        </div>
        <div class="canvas-controls">
          <span>Click = Balloon · Drag = Arrow</span>
          <button id="clear-annotations" class="secondary">Clear</button>
          <button id="remove-image-btn" class="secondary" style="display: none;">Remove Image</button>
        </div>
      </section>

      <!-- Confirmation dialog for removing image -->
      <dialog id="remove-image-confirm-dialog">
        <form method="dialog">
          <h3>Remove Image?</h3>
          <p>Are you sure you want to remove the image? This will also clear all annotations.</p>
          <div class="table-actions">
            <button type="submit" id="remove-image-confirm-btn" style="background: var(--danger); border-color: var(--danger);">Remove</button>
            <button type="button" value="cancel" class="secondary">Cancel</button>
          </div>
        </form>
      </dialog>

      <section id="data-grid">
        <h2>Stack Data</h2>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th style="width: 40px;"></th>
                <th style="width: 60px;">Item Nr</th>
                <th style="width: 100px;">Part Nr</th>
                <th>Description</th>
                <th>Nominal</th>
                <th>Direction</th>
                <th class="advanced-col tolerance-type-col" style="display: none;">Tolerance Type</th>
                <th>Tol (+/-)</th>
                <th class="advanced-col cpk-col" style="display: none;">Cpk</th>
                <th class="advanced-col float-col" style="display: none;">Float Shifted</th>
                <th style="width: 60px;">Notes</th>
                <th style="width: 60px;">Source</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="stack-body"></tbody>
          </table>
        </div>
        <div class="table-actions">
          <button id="add-row">Add Row</button>
        </div>
      </section>

      <section id="dashboard">
        <h2>Dashboard</h2>
        <div class="dashboard-container">
          <!-- Row 1: Specification Limits -->
          <div class="stats-row">
            <div class="stat-card" id="stat-nominal-target-card" data-column="1" style="display: none;">
              <span class="stat-label">Nominal Target</span>
              <span class="stat-value" id="stat-nominal-target">—</span>
            </div>
            <div class="stat-card" id="stat-lsl-card" data-column="2" style="display: none;">
              <span class="stat-label">Lower Spec Limit (LSL)</span>
              <span class="stat-value" id="stat-lsl">—</span>
            </div>
            <div class="stat-card" id="stat-usl-card" data-column="3" style="display: none;">
              <span class="stat-label">Upper Spec Limit (USL)</span>
              <span class="stat-value" id="stat-usl">—</span>
            </div>
            <div class="stat-card" id="stat-spec-tolerance-card" data-column="4" style="display: none;">
              <span class="stat-label">Spec Tolerance (±)</span>
              <span class="stat-value" id="stat-spec-tolerance">—</span>
            </div>
          </div>

          <!-- Row 2: Analysis Results -->
          <div class="stats-row">
            <div class="stat-card" data-column="1">
              <span class="stat-label">Stack Mean</span>
              <span class="stat-value" id="stat-mean">0.000</span>
            </div>
            <div class="stat-card advanced-stat" id="stat-mean-minus-3sigma-card" data-column="2" style="display: none;">
              <span class="stat-label">Stack Mean - 3σ</span>
              <span class="stat-value" id="stat-mean-minus-3sigma">—</span>
            </div>
            <div class="stat-card advanced-stat" id="stat-mean-plus-3sigma-card" data-column="3" style="display: none;">
              <span class="stat-label">Stack Mean + 3σ</span>
              <span class="stat-value" id="stat-mean-plus-3sigma">—</span>
            </div>
            <div class="stat-card advanced-stat" id="stat-3sigma-card" data-column="4" style="display: none;">
              <span class="stat-label">Process Range</span>
              <span class="stat-value" id="stat-3sigma">±0.000</span>
            </div>
            <!-- Basic mode with worst case acceptance criteria -->
            <div class="stat-card basic-stat" id="stat-mean-minus-worst-case-card" data-column="2" style="display: none;">
              <span class="stat-label">Stack Mean - Worst Case Tol</span>
              <span class="stat-value" id="stat-mean-minus-worst-case">—</span>
            </div>
            <div class="stat-card basic-stat" id="stat-mean-plus-worst-case-card" data-column="3" style="display: none;">
              <span class="stat-label">Stack Mean + Worst Case Tol</span>
              <span class="stat-value" id="stat-mean-plus-worst-case">—</span>
            </div>
            <div class="stat-card basic-stat" id="stat-worst-case-tol-card" data-column="4" style="display: none;">
              <span class="stat-label">Worst Case Tol (+/-)</span>
              <span class="stat-value" id="stat-worst-case-tol">±0.000</span>
            </div>
            <!-- Basic mode with RSS acceptance criteria -->
            <div class="stat-card basic-stat" id="stat-mean-minus-rss-card" data-column="2" style="display: none;">
              <span class="stat-label">Stack Mean - RSS</span>
              <span class="stat-value" id="stat-mean-minus-rss">—</span>
            </div>
            <div class="stat-card basic-stat" id="stat-mean-plus-rss-card" data-column="3" style="display: none;">
              <span class="stat-label">Stack Mean + RSS</span>
              <span class="stat-value" id="stat-mean-plus-rss">—</span>
            </div>
            <div class="stat-card basic-stat" id="stat-rss-tol-card" data-column="4" style="display: none;">
              <span class="stat-label">RSS Tol (+/-)</span>
              <span class="stat-value" id="stat-rss-tol">±0.000</span>
            </div>
            <!-- Legacy boxes (hidden when acceptance criteria is set) -->
            <div class="stat-card basic-stat" id="stat-worst-case-card" data-column="2">
              <span class="stat-label">Worst Case</span>
              <span class="stat-value" id="stat-worst-case">±0.000</span>
            </div>
            <div class="stat-card basic-stat" id="stat-rss-card" data-column="3">
              <span class="stat-label">RSS</span>
              <span class="stat-value" id="stat-rss">±0.000</span>
            </div>
          </div>

          <!-- Row 3: Acceptance Criteria and Results -->
          <div class="stats-row">
            <div class="stat-card" id="stat-acceptance-criteria-card" style="display: none;">
              <span class="stat-label">Acceptance Criteria</span>
              <span class="stat-value" id="stat-acceptance-criteria">—</span>
            </div>
            <div class="stat-card advanced-stat" id="stat-achieved-cpk-card" style="display: none;">
              <span class="stat-label">Achieved Cpk</span>
              <span class="stat-value" id="stat-achieved-cpk">—</span>
            </div>
            <div class="stat-card" id="stat-acceptance-card" style="display: none;">
              <div class="acceptance-result">
                <span class="acceptance-indicator" id="acceptance-indicator"></span>
                <span class="stat-value" id="stat-acceptance">—</span>
              </div>
            </div>
          </div>
          
          <!-- Normal Distribution Plot (Advanced Mode Only) -->
          <div class="advanced-stat" id="distribution-plot-container" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
              <h3 style="margin: 0;">Normal Distribution</h3>
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; user-select: none;">
                <input type="checkbox" id="process-drift-toggle" style="cursor: pointer;">
                <span style="font-size: 0.875rem; color: var(--muted);">Simulate long term process drift</span>
              </label>
            </div>
            <canvas id="distribution-plot" width="600" height="300"></canvas>
          </div>
          <div class="advanced-stat" id="distribution-plot-stats" style="display: none;"></div>
        </div>
        <h3>Pareto Contributions</h3>
        <div class="pareto-info">
          <p class="pareto-explanation">
            The Pareto Principle (80/20 rule) states that roughly 80% of effects come from 20% of causes. 
            In tolerance analysis, this means a small number of dimensions typically contribute most to stack variation. 
            <strong>Focusing improvement efforts on the "vital few" dimensions will yield the greatest impact.</strong>
          </p>
        </div>
        <div id="pareto-chart"></div>
        <div class="pareto-legend"></div>
      </section>
    </main>

    <dialog id="settings-dialog">
      <form method="dialog">
        <h3>Settings</h3>
        <div class="settings-group">
          <h4>Advanced Features</h4>
          <label class="setting-toggle">
            <input type="checkbox" id="setting-advanced-statistical-mode" />
            <span>Advanced statistical mode using expected Cpk values</span>
          </label>
          <label class="setting-toggle">
            <input type="checkbox" id="setting-tolerance-type" />
            <span>Show Tolerance Type (Linear/GD&T/Float)</span>
          </label>
          <label class="setting-toggle">
            <input type="checkbox" id="setting-float-shifted" />
            <span>Show Float Shifted</span>
          </label>
        </div>
        <div class="table-actions">
          <button value="cancel" class="secondary">Close</button>
        </div>
      </form>
    </dialog>

    <dialog id="notes-dialog">
      <form method="dialog">
        <h3>Notes</h3>
        <label>
          <textarea id="notes-textarea" rows="8" placeholder="Enter notes here..."></textarea>
        </label>
        <div class="table-actions">
          <button type="button" id="notes-ok-btn">OK</button>
          <button value="cancel" class="secondary">Cancel</button>
        </div>
      </form>
    </dialog>

    <dialog id="source-dialog">
      <form method="dialog">
        <h3>Source Image</h3>
        <div class="source-container">
          <div class="source-upload-area" id="source-upload-area">
            <input type="file" id="source-file-input" accept="image/*" style="display: none;">
            <div class="upload-placeholder" id="upload-placeholder">
              <p>Drop image here, paste from clipboard, or click to upload</p>
              <button type="button" class="secondary" id="source-upload-btn">Choose File</button>
            </div>
            <div class="source-image-wrapper" id="source-image-wrapper" style="display: none;">
              <img id="source-image" alt="Source image">
              <canvas id="source-canvas"></canvas>
            </div>
          </div>
          <div class="source-actions">
            <button type="button" class="secondary" id="source-remove-btn" style="display: none;">Remove Image</button>
          </div>
        </div>
        <div class="table-actions">
          <button type="button" id="source-ok-btn">OK</button>
          <button value="cancel" class="secondary">Cancel</button>
        </div>
      </form>
    </dialog>

    <dialog id="analysis-setup-dialog">
      <form method="dialog">
        <h3>Analysis Setup</h3>
        
        <div class="form-section">
          <h4>Metadata</h4>
          <label>
            Analysis Title
            <input type="text" id="analysis-title" placeholder="Enter analysis title">
          </label>
          <label>
            Project
            <input type="text" id="analysis-project" placeholder="Enter project name">
          </label>
          <label>
            Part/Assembly Nr
            <input type="text" id="analysis-part-nr" placeholder="Enter part/assembly number">
          </label>
          <label>
            Analyst Name/ID
            <input type="text" id="analysis-analyst" placeholder="Enter analyst name or ID">
          </label>
          <label>
            Creation Date
            <input type="date" id="analysis-creation-date">
          </label>
        </div>

        <div class="form-section">
          <h4>Critical Requirement</h4>
          <label>
            Critical Feature/Gap Measured
            <input type="text" id="analysis-critical-feature" placeholder="Enter critical feature or gap">
          </label>
          <label>
            Nominal Target Value
            <input type="number" step="0.001" id="analysis-nominal-target" placeholder="Enter nominal target value">
          </label>
          <label>
            Lower Specification Limit (LSL)
            <input type="number" step="0.001" id="analysis-lsl" placeholder="Enter LSL">
          </label>
          <label>
            Upper Specification Limit (USL)
            <input type="number" step="0.001" id="analysis-usl" placeholder="Enter USL">
          </label>
          <label>
            Acceptance Criteria
            <select id="analysis-acceptance-criteria">
              <!-- Options will be populated dynamically -->
            </select>
          </label>
        </div>

        <div class="form-section">
          <h4>Assumptions Context</h4>
          <label>
            Functional Description / Notes
            <textarea id="analysis-functional-description" rows="4" placeholder="Enter functional description or notes"></textarea>
          </label>
        </div>

        <div class="table-actions">
          <button type="button" id="analysis-setup-ok-btn">OK</button>
          <button value="cancel" class="secondary">Cancel</button>
        </div>
      </form>
    </dialog>

    <dialog id="help-dialog">
      <form method="dialog">
        <div class="help-container">
          <div class="help-toc">
            <h3>Contents</h3>
            <ul class="toc-list">
              <li><a href="#help-introduction" class="toc-link">Introduction</a></li>
              <li><a href="#help-worst-case" class="toc-link">Worst Case Tolerance</a></li>
              <li><a href="#help-rss" class="toc-link">RSS (Root Sum Square)</a></li>
              <li><a href="#help-cpk" class="toc-link">Cpk (Process Capability)</a></li>
              <li><a href="#help-statistical" class="toc-link">Statistical Analysis</a></li>
              <li><a href="#help-pareto" class="toc-link">Pareto Chart</a></li>
              <li><a href="#help-direction" class="toc-link">Direction (+/-)</a></li>
              <li><a href="#help-non-centered" class="toc-link">Non-Centered Tolerances</a></li>
              <li><a href="#help-gdt" class="toc-link">GD&T Overview</a></li>
              <li><a href="#help-positional" class="toc-link">Positional Tolerance</a></li>
              <li><a href="#help-profile" class="toc-link">Surface Profile</a></li>
              <li><a href="#help-mmc" class="toc-link">MMC (Maximum Material Condition)</a></li>
              <li><a href="#help-datum-shift" class="toc-link">Datum Shift</a></li>
              <li><a href="#help-using" class="toc-link">Using the Tool</a></li>
            </ul>
          </div>
          <div class="help-content">
            <section id="help-introduction" class="help-section">
              <h2>Introduction</h2>
              <p>StackMaster is a tolerance analysis tool designed to help engineers analyze dimensional tolerances in assemblies. It calculates how individual component tolerances combine to affect the overall assembly dimension.</p>
              <p>This tool supports both basic tolerance analysis methods (Worst Case and RSS) and advanced statistical analysis using process capability indices (Cpk).</p>
            </section>

            <section id="help-worst-case" class="help-section">
              <h2>Worst Case Tolerance</h2>
              <p><strong>Worst Case Tolerance</strong> is a conservative tolerance analysis method that assumes all dimensions are at their extreme limits simultaneously.</p>
              <h3>Calculation</h3>
              <p>For a stack of dimensions, the worst case tolerance is calculated as:</p>
              <p class="formula">Worst Case = Σ(tolerances)</p>
              <p>Where each tolerance is added together, assuming the worst possible combination of all dimensions being at their maximum or minimum limits.</p>
              <h3>When to Use</h3>
              <ul>
                <li>Safety-critical applications where failure is not acceptable</li>
                <li>When you need a conservative, guaranteed worst-case scenario</li>
                <li>For simple assemblies with few components</li>
                <li>When statistical data is not available</li>
              </ul>
              <h3>Limitations</h3>
              <p>Worst case analysis often results in overly conservative tolerances, which can lead to unnecessarily tight manufacturing requirements and higher costs.</p>
            </section>

            <section id="help-rss" class="help-section">
              <h2>RSS (Root Sum Square)</h2>
              <p><strong>RSS (Root Sum Square)</strong> is a statistical tolerance analysis method that accounts for the probability that all dimensions will not be at their extremes simultaneously.</p>
              <h3>Calculation</h3>
              <p>The RSS tolerance is calculated as:</p>
              <p class="formula">RSS = √(Σ(tolerance²))</p>
              <p>This method assumes that dimensional variations follow a normal distribution and are statistically independent.</p>
              <h3>When to Use</h3>
              <ul>
                <li>When you have multiple components in an assembly</li>
                <li>For cost-effective tolerance allocation</li>
                <li>When dimensions are statistically independent</li>
                <li>For production environments with normal process variation</li>
              </ul>
              <h3>Assumptions</h3>
              <ul>
                <li>Dimensions follow a normal (Gaussian) distribution</li>
                <li>Dimensions are centered on their nominal values</li>
                <li>Variations are statistically independent</li>
                <li>Process is in statistical control</li>
              </ul>
            </section>

            <section id="help-cpk" class="help-section">
              <h2>Cpk (Process Capability Index)</h2>
              <p><strong>Cpk</strong> is a statistical measure of process capability that indicates how well a process can produce parts within specification limits.</p>
              <h3>Calculation</h3>
              <p>Cpk is calculated as:</p>
              <p class="formula">Cpk = min[(USL - μ) / (3σ), (μ - LSL) / (3σ)]</p>
              <p>Where:</p>
              <ul>
                <li><strong>USL</strong> = Upper Specification Limit</li>
                <li><strong>LSL</strong> = Lower Specification Limit</li>
                <li><strong>μ</strong> = Process mean</li>
                <li><strong>σ</strong> = Process standard deviation</li>
              </ul>
              <h3>Interpretation</h3>
              <ul>
                <li><strong>Cpk &lt; 1.0</strong>: Process is not capable, parts will be out of spec</li>
                <li><strong>Cpk = 1.0</strong>: Process is marginally capable (~0.27% out of spec)</li>
                <li><strong>Cpk = 1.33</strong>: Process is capable (~0.0063% out of spec)</li>
                <li><strong>Cpk = 1.67</strong>: Process is highly capable (~0.00006% out of spec)</li>
                <li><strong>Cpk = 2.0</strong>: Six Sigma quality (~0.0000002% out of spec)</li>
              </ul>
              <h3>In Tolerance Analysis</h3>
              <p>When using advanced statistical mode, you can specify expected Cpk values for each component. The tool then calculates the statistical variation (sigma) and predicts the probability of the assembly being within specification limits.</p>
            </section>

            <section id="help-statistical" class="help-section">
              <h2>Statistical Analysis</h2>
              <p>When <strong>Advanced Statistical Mode</strong> is enabled, the tool uses Cpk values to calculate statistical variations.</p>
              <h3>Standard Deviation (σ)</h3>
              <p>The standard deviation represents the spread of the dimensional distribution. It's calculated from the tolerance and Cpk value:</p>
              <p class="formula">σ = Tolerance / (3 × Cpk)</p>
              <h3>Process Ranges</h3>
              <p>The tool calculates various process ranges:</p>
              <ul>
                <li><strong>3σ Range</strong>: 99.73% of parts will be within ±3 standard deviations</li>
                <li><strong>4σ Range</strong>: 99.99% of parts will be within ±4 standard deviations</li>
                <li><strong>5σ Range</strong>: 99.9999% of parts will be within ±5 standard deviations</li>
                <li><strong>6σ Range</strong>: 99.9999998% of parts will be within ±6 standard deviations (Six Sigma)</li>
              </ul>
              <h3>Stack Mean</h3>
              <p>The stack mean is calculated by summing the nominal values, accounting for direction (+ or -). Positive dimensions add to the stack, negative dimensions subtract from it.</p>
            </section>

            <section id="help-pareto" class="help-section">
              <h2>Pareto Chart</h2>
              <p>The <strong>Pareto Chart</strong> visualizes the contribution of each dimension to the total tolerance variation.</p>
              <h3>Purpose</h3>
              <p>The Pareto principle (80/20 rule) suggests that typically 80% of the variation comes from 20% of the components. The chart helps identify:</p>
              <ul>
                <li><strong>Vital Few</strong>: Components contributing most to variation (shown in red)</li>
                <li><strong>Trivial Many</strong>: Components with minimal contribution (shown in blue)</li>
              </ul>
              <h3>How to Read</h3>
              <ul>
                <li><strong>Bars</strong>: Show the percentage contribution of each dimension</li>
                <li><strong>Line</strong>: Shows cumulative contribution percentage</li>
                <li><strong>80% Line</strong>: Helps identify the vital few components</li>
              </ul>
              <h3>Using the Chart</h3>
              <p>Focus your tolerance improvement efforts on the "vital few" components (red bars) to achieve the most significant impact on overall assembly variation.</p>
            </section>

            <section id="help-direction" class="help-section">
              <h2>Direction (+/-)</h2>
              <p>The <strong>Direction</strong> column indicates whether a dimension contributes positively or negatively to the overall stack.</p>
              <h3>Positive (+)</h3>
              <p>A positive direction means the dimension adds to the stack. For example, in a height stack, each component's thickness adds to the total height.</p>
              <h3>Negative (-)</h3>
              <p>A negative direction means the dimension subtracts from the stack. For example, a clearance or gap that reduces the overall dimension.</p>
              <h3>Example</h3>
              <p>In an assembly height calculation:</p>
              <ul>
                <li>Base plate thickness: <strong>+</strong> (adds to height)</li>
                <li>Spacer block: <strong>+</strong> (adds to height)</li>
                <li>Clearance gap: <strong>-</strong> (reduces effective height)</li>
              </ul>
            </section>

            <section id="help-non-centered" class="help-section">
              <h2>Non-Centered Tolerances</h2>
              <p>Many manufacturing tolerances are not centered on the nominal value. Before entering a tolerance into the sheet, you may need to convert it to a centered ± tolerance format.</p>
              <h3>Understanding Non-Centered Tolerances</h3>
              <p>Non-centered tolerances are specified as asymmetric limits, such as:</p>
              <ul>
                <li><strong>25.0 +0.2 / -0.1</strong> (upper limit: 25.2, lower limit: 24.9)</li>
                <li><strong>12.5 +0.05 / -0.15</strong> (upper limit: 12.55, lower limit: 12.35)</li>
                <li><strong>10.0 +0.1 / +0.0</strong> (upper limit: 10.1, lower limit: 10.0)</li>
              </ul>
              <h3>Converting to Centered Tolerance</h3>
              <p>To convert a non-centered tolerance to a centered ± format:</p>
              <ol>
                <li><strong>Calculate the mean</strong>: Mean = (Upper Limit + Lower Limit) / 2</li>
                <li><strong>Calculate the tolerance</strong>: Tolerance = (Upper Limit - Lower Limit) / 2</li>
                <li><strong>Enter the mean as Nominal</strong>: Use the calculated mean value</li>
                <li><strong>Enter the tolerance</strong>: Use the calculated tolerance value</li>
              </ol>
              <h3>Example Conversion</h3>
              <p><strong>Original specification:</strong> 25.0 +0.2 / -0.1</p>
              <ul>
                <li>Upper Limit = 25.0 + 0.2 = 25.2</li>
                <li>Lower Limit = 25.0 - 0.1 = 24.9</li>
                <li>Mean = (25.2 + 24.9) / 2 = 25.05</li>
                <li>Tolerance = (25.2 - 24.9) / 2 = 0.15</li>
              </ul>
              <p><strong>Enter in sheet:</strong></p>
              <ul>
                <li>Nominal: <strong>25.05</strong></li>
                <li>Tolerance: <strong>±0.15</strong></li>
              </ul>
              <h3>Important Notes</h3>
              <ul>
                <li>This conversion maintains the same tolerance zone but centers it on the mean</li>
                <li>The original limits (25.2 and 24.9) are still respected in the analysis</li>
                <li>For worst case analysis, this conversion is exact</li>
                <li>For statistical analysis, ensure the process is centered on the new nominal</li>
              </ul>
            </section>

            <section id="help-gdt" class="help-section">
              <h2>GD&T (Geometric Dimensioning and Tolerancing)</h2>
              <p><strong>GD&T</strong> is a symbolic language used to specify the geometric characteristics of parts. Unlike linear tolerances, GD&T controls form, orientation, location, and runout.</p>
              <h3>When to Use GD&T</h3>
              <ul>
                <li>When functional requirements need to be specified</li>
                <li>For features that must mate or assemble with other parts</li>
                <li>When you need to control form, orientation, or location</li>
                <li>To allow additional tolerance through MMC or LMC modifiers</li>
              </ul>
              <h3>Common GD&T Symbols</h3>
              <ul>
                <li><strong>Position</strong> (⌖): Controls the location of features</li>
                <li><strong>Profile</strong> (⌓): Controls the shape of surfaces</li>
                <li><strong>Flatness</strong>: Controls how flat a surface is</li>
                <li><strong>Perpendicularity</strong> (⊥): Controls 90° relationships</li>
                <li><strong>Parallelism</strong> (∥): Controls parallel relationships</li>
              </ul>
              <h3>Entering GD&T in the Tool</h3>
              <p>When entering GD&T tolerances:</p>
              <ol>
                <li>Select <strong>"GD&T"</strong> as the Tolerance Type (when advanced mode is enabled)</li>
                <li>Enter the tolerance value as specified on the drawing</li>
                <li>Consider MMC/LMC modifiers if applicable (see MMC section)</li>
                <li>Account for datum shift if multiple datums are used (see Datum Shift section)</li>
              </ol>
            </section>

            <section id="help-positional" class="help-section">
              <h2>Positional Tolerance</h2>
              <p><strong>Positional tolerance</strong> (⌖) controls the location of features relative to datums. It's one of the most commonly used GD&T controls.</p>
              <h3>Understanding Positional Tolerance</h3>
              <p>Positional tolerance creates a cylindrical or spherical tolerance zone within which the center point or axis of a feature must lie.</p>
              <h3>Entering Positional Tolerance</h3>
              <p><strong>Step 1: Identify the tolerance value</strong></p>
              <p>Find the positional tolerance value on the drawing (e.g., ⌖ 0.1). This is the diameter of the tolerance zone.</p>
              <p><strong>Step 2: Determine the contribution to stack</strong></p>
              <p>For tolerance stack-up analysis, positional tolerance contributes as:</p>
              <p class="formula">Contribution = Positional Tolerance / 2</p>
              <p>This converts the diameter tolerance zone to a radius contribution.</p>
              <p><strong>Step 3: Enter in the tool</strong></p>
              <ul>
                <li>Nominal: Enter the basic dimension or target location</li>
                <li>Tolerance: Enter <strong>half</strong> of the positional tolerance value</li>
                <li>Tolerance Type: Select <strong>"GD&T"</strong></li>
              </ul>
              <h3>Example</h3>
              <p><strong>Drawing callout:</strong> ⌖ 0.2 (positional tolerance of 0.2)</p>
              <p><strong>Enter in sheet:</strong></p>
              <ul>
                <li>Nominal: <strong>25.0</strong> (basic dimension)</li>
                <li>Tolerance: <strong>±0.1</strong> (0.2 / 2 = 0.1)</li>
                <li>Tolerance Type: <strong>GD&T</strong></li>
              </ul>
              <h3>With MMC Modifier</h3>
              <p>If the positional tolerance includes an MMC modifier (⌖ 0.2 Ⓜ), see the MMC section for how to account for the bonus tolerance.</p>
            </section>

            <section id="help-profile" class="help-section">
              <h2>Surface Profile Tolerance</h2>
              <p><strong>Surface profile</strong> (⌓) controls the shape of a surface relative to a true profile. It can be applied to individual line elements or the entire surface.</p>
              <h3>Understanding Profile Tolerance</h3>
              <p>Profile tolerance creates a bilateral zone (equal on both sides) or unilateral zone around the true profile. The tolerance value specifies the total width of the zone.</p>
              <h3>Entering Profile Tolerance</h3>
              <p><strong>Step 1: Identify the tolerance value</strong></p>
              <p>Find the profile tolerance on the drawing (e.g., ⌓ 0.05). This is the total width of the tolerance zone.</p>
              <p><strong>Step 2: Determine the contribution</strong></p>
              <p>For bilateral profile (most common):</p>
              <p class="formula">Contribution = Profile Tolerance / 2</p>
              <p>For unilateral profile (specified with a leader or note):</p>
              <p class="formula">Contribution = Profile Tolerance</p>
              <p><strong>Step 3: Enter in the tool</strong></p>
              <ul>
                <li>Nominal: Enter the target dimension or profile location</li>
                <li>Tolerance: Enter the calculated contribution value</li>
                <li>Tolerance Type: Select <strong>"GD&T"</strong></li>
              </ul>
              <h3>Example - Bilateral Profile</h3>
              <p><strong>Drawing callout:</strong> ⌓ 0.1 (bilateral profile tolerance)</p>
              <p><strong>Enter in sheet:</strong></p>
              <ul>
                <li>Nominal: <strong>12.5</strong></li>
                <li>Tolerance: <strong>±0.05</strong> (0.1 / 2 = 0.05)</li>
                <li>Tolerance Type: <strong>GD&T</strong></li>
              </ul>
              <h3>Example - Unilateral Profile</h3>
              <p><strong>Drawing callout:</strong> ⌓ 0.1 (unilateral, material outside)</p>
              <p><strong>Enter in sheet:</strong></p>
              <ul>
                <li>Nominal: <strong>12.5</strong></li>
                <li>Tolerance: <strong>±0.1</strong> (full tolerance value)</li>
                <li>Tolerance Type: <strong>GD&T</strong></li>
              </ul>
            </section>

            <section id="help-mmc" class="help-section">
              <h2>MMC (Maximum Material Condition)</h2>
              <p><strong>MMC</strong> (Ⓜ) is a material condition modifier that allows additional tolerance when a feature departs from its maximum material condition.</p>
              <h3>Understanding MMC</h3>
              <p><strong>Maximum Material Condition</strong> is the condition where a feature contains the maximum amount of material:</p>
              <ul>
                <li>For external features (shafts, pins): Largest size</li>
                <li>For internal features (holes, slots): Smallest size</li>
              </ul>
              <h3>Bonus Tolerance</h3>
              <p>When a feature is at MMC, it gets the stated tolerance. As the feature departs from MMC, it receives additional "bonus" tolerance:</p>
              <p class="formula">Total Tolerance = Stated Tolerance + Bonus Tolerance</p>
              <p class="formula">Bonus Tolerance = |Actual Size - MMC Size|</p>
              <h3>Entering MMC Tolerances</h3>
              <p><strong>Conservative Approach (Recommended for Stack Analysis)</strong></p>
              <p>For worst-case stack analysis, use the maximum possible tolerance:</p>
              <ol>
                <li>Start with the stated positional/profile tolerance</li>
                <li>Add the maximum bonus tolerance (size tolerance of the feature)</li>
                <li>Enter this total as the tolerance value</li>
              </ol>
              <p><strong>Example: Positional with MMC</strong></p>
              <p><strong>Drawing callout:</strong> ⌖ 0.1 Ⓜ (positional tolerance 0.1 at MMC)</p>
              <p><strong>Feature size:</strong> Hole Ø10.0 +0.1 / -0.0</p>
              <ul>
                <li>Stated tolerance: 0.1</li>
                <li>Size tolerance: 0.1 (maximum bonus)</li>
                <li>Maximum total tolerance: 0.1 + 0.1 = 0.2</li>
              </ul>
              <p><strong>Enter in sheet:</strong></p>
              <ul>
                <li>Nominal: <strong>25.0</strong></li>
                <li>Tolerance: <strong>±0.1</strong> (0.2 / 2 = 0.1, since it's a diameter)</li>
                <li>Tolerance Type: <strong>GD&T</strong></li>
              </ul>
              <h3>Statistical Approach</h3>
              <p>For statistical analysis, you may use the average bonus tolerance or the stated tolerance only, depending on your process capability data.</p>
            </section>

            <section id="help-datum-shift" class="help-section">
              <h2>Datum Shift</h2>
              <p><strong>Datum shift</strong> occurs when a datum feature departs from its maximum material condition, allowing the tolerance zone to shift relative to the datum.</p>
              <h3>Understanding Datum Shift</h3>
              <p>When a datum feature is referenced at MMC (Ⓜ), the datum itself can shift if the datum feature is not at MMC. This shift adds to the available tolerance zone.</p>
              <h3>Calculating Datum Shift</h3>
              <p>Datum shift is calculated as:</p>
              <p class="formula">Datum Shift = |Datum Feature Actual Size - Datum Feature MMC Size|</p>
              <h3>Entering Datum Shift in Stack Analysis</h3>
              <p><strong>Step 1: Identify datum features with MMC</strong></p>
              <p>Look for datums in the feature control frame that have the Ⓜ modifier (e.g., ⌖ 0.1 Ⓜ | A Ⓜ B Ⓜ)</p>
              <p><strong>Step 2: Calculate shift for each datum</strong></p>
              <p>For each datum at MMC, calculate how much it can shift based on its size tolerance.</p>
              <p><strong>Step 3: Combine with feature tolerance</strong></p>
              <p>The total tolerance contribution includes:</p>
              <ul>
                <li>Feature positional/profile tolerance</li>
                <li>Feature bonus tolerance (if feature is at MMC)</li>
                <li>Datum shift from all datums at MMC</li>
              </ul>
              <p class="formula">Total Contribution = (Feature Tolerance + Feature Bonus + Datum Shifts) / 2</p>
              <h3>Example: Positional with Multiple Datums at MMC</h3>
              <p><strong>Drawing callout:</strong> ⌖ 0.15 Ⓜ | A Ⓜ B Ⓜ C</p>
              <p><strong>Feature:</strong> Hole Ø8.0 +0.05 / -0.0</p>
              <p><strong>Datum A:</strong> Pin Ø12.0 +0.0 / -0.1</p>
              <p><strong>Datum B:</strong> Pin Ø10.0 +0.0 / -0.08</p>
              <p><strong>Datum C:</strong> Surface (no MMC)</p>
              <p><strong>Calculations:</strong></p>
              <ul>
                <li>Feature stated tolerance: 0.15</li>
                <li>Feature bonus (max): 0.05</li>
                <li>Datum A shift (max): 0.1</li>
                <li>Datum B shift (max): 0.08</li>
                <li>Datum C shift: 0 (no MMC)</li>
                <li>Total diameter tolerance: 0.15 + 0.05 + 0.1 + 0.08 = 0.38</li>
                <li>Radius contribution: 0.38 / 2 = 0.19</li>
              </ul>
              <p><strong>Enter in sheet (worst case):</strong></p>
              <ul>
                <li>Nominal: <strong>25.0</strong></li>
                <li>Tolerance: <strong>±0.19</strong></li>
                <li>Tolerance Type: <strong>GD&T</strong></li>
              </ul>
              <h3>Important Notes</h3>
              <ul>
                <li>Datum shift only applies when the datum is referenced at MMC (Ⓜ)</li>
                <li>For worst-case analysis, use maximum possible shifts</li>
                <li>For statistical analysis, consider the probability of maximum shifts occurring simultaneously</li>
                <li>Datum shifts are vector quantities - ensure proper direction in complex stacks</li>
              </ul>
            </section>

            <section id="help-using" class="help-section">
              <h2>Using the Tool</h2>
              <h3>Basic Workflow</h3>
              <ol>
                <li><strong>Analysis Setup</strong>: Enter metadata, critical requirements, and assumptions</li>
                <li><strong>Add Dimensions</strong>: Enter each component's nominal value, tolerance, and direction</li>
                <li><strong>Review Results</strong>: Check Worst Case and RSS tolerances</li>
                <li><strong>Analyze Pareto Chart</strong>: Identify critical components</li>
                <li><strong>Optimize</strong>: Adjust tolerances based on analysis</li>
              </ol>
              <h3>Advanced Features</h3>
              <ul>
                <li><strong>Advanced Statistical Mode</strong>: Enable in Settings to use Cpk-based analysis</li>
                <li><strong>Notes</strong>: Add notes to each dimension for documentation</li>
                <li><strong>Source Images</strong>: Attach images with highlighted areas</li>
                <li><strong>Drag and Drop</strong>: Reorder dimensions by dragging rows</li>
              </ul>
              <h3>Tips</h3>
              <ul>
                <li>Start with basic mode to get a quick assessment</li>
                <li>Use advanced mode when you have Cpk data from manufacturing</li>
                <li>Focus tolerance improvements on components shown in red in the Pareto chart</li>
                <li>Document assumptions and context in the Analysis Setup</li>
              </ul>
            </section>
          </div>
        </div>
        <div class="table-actions">
          <button value="cancel" class="secondary">Close</button>
        </div>
      </form>
    </dialog>

    <script type="module" src="js/main.js"></script>
  </body>
</html>

