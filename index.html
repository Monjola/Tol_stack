<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>StackMaster | Tolerance Analysis</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <header>
      <h1>StackMaster · Tolerance Analysis</h1>
      <div style="display: flex; gap: 0.5rem;">
        <button id="open-analysis-setup-dialog" class="secondary">Analysis Setup</button>
        <button id="open-settings-dialog" class="secondary">Settings</button>
      </div>
    </header>

    <main>
      <section id="canvas-container">
        <h2>Visual Canvas</h2>
        <input type="file" id="drawing-upload" accept="image/*" />
        <div class="canvas-wrapper">
          <img id="drawing-img" alt="Drawing background" />
          <canvas id="drawing-canvas"></canvas>
        </div>
        <div class="canvas-controls">
          <span>Click = Balloon · Drag = Arrow</span>
          <button id="clear-annotations" class="secondary">Clear</button>
        </div>
      </section>

      <section id="data-grid">
        <h2>Stack Data</h2>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th style="width: 40px;"></th>
                <th style="width: 60px;">Item Nr</th>
                <th style="width: 100px;">Part Nr</th>
                <th>Description</th>
                <th>Nominal</th>
                <th>Direction</th>
                <th class="advanced-col tolerance-type-col" style="display: none;">Tolerance Type</th>
                <th>Tol (+/-)</th>
                <th class="advanced-col cpk-col" style="display: none;">Cpk</th>
                <th class="advanced-col float-col" style="display: none;">Float Shifted</th>
                <th style="width: 60px;">Notes</th>
                <th style="width: 60px;">Source</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="stack-body"></tbody>
          </table>
        </div>
        <div class="table-actions">
          <button id="add-row">Add Row</button>
        </div>
      </section>

      <section id="dashboard">
        <h2>Dashboard</h2>
        <div class="stats-grid">
          <div class="stat-card">
            <span class="stat-label">Stack Mean</span>
            <span class="stat-value" id="stat-mean">0.000</span>
          </div>
          <div class="stat-card basic-stat" id="stat-worst-case-card">
            <span class="stat-label">Worst Case</span>
            <span class="stat-value" id="stat-worst-case">±0.000</span>
          </div>
          <div class="stat-card basic-stat" id="stat-rss-card">
            <span class="stat-label">RSS</span>
            <span class="stat-value" id="stat-rss">±0.000</span>
          </div>
          <div class="stat-card advanced-stat" id="stat-sigma-card" style="display: none;">
            <span class="stat-label">Standard Deviation</span>
            <span class="stat-value" id="stat-sigma">±0.000</span>
          </div>
          <div class="stat-card advanced-stat" id="stat-3sigma-card" style="display: none;">
            <span class="stat-label">Process Range (3 standard deviations, Cpk=1)</span>
            <span class="stat-value" id="stat-3sigma">±0.000</span>
          </div>
          <div class="stat-card advanced-stat" id="stat-4sigma-card" style="display: none;">
            <span class="stat-label">4 standard deviations, Cpk=1.33</span>
            <span class="stat-value" id="stat-4sigma">±0.000</span>
          </div>
          <div class="stat-card advanced-stat" id="stat-5sigma-card" style="display: none;">
            <span class="stat-label">5 standard deviations, Cpk=1.67</span>
            <span class="stat-value" id="stat-5sigma">±0.000</span>
          </div>
          <div class="stat-card advanced-stat" id="stat-6sigma-card" style="display: none;">
            <span class="stat-label">+/-6 standard deviations, Cpk=2</span>
            <span class="stat-value" id="stat-6sigma">±0.000</span>
          </div>
        </div>
        <h3>Pareto Contributions</h3>
        <div class="pareto-info">
          <p class="pareto-explanation">
            The Pareto Principle (80/20 rule) states that roughly 80% of effects come from 20% of causes. 
            In tolerance analysis, this means a small number of dimensions typically contribute most to stack variation. 
            <strong>Focusing improvement efforts on the "vital few" dimensions will yield the greatest impact.</strong>
          </p>
        </div>
        <div id="pareto-chart"></div>
        <div class="pareto-legend"></div>
      </section>
    </main>

    <dialog id="settings-dialog">
      <form method="dialog">
        <h3>Settings</h3>
        <div class="settings-group">
          <h4>Advanced Features</h4>
          <label class="setting-toggle">
            <input type="checkbox" id="setting-advanced-statistical-mode" />
            <span>Advanced statistical mode using expected Cpk values</span>
          </label>
          <label class="setting-toggle">
            <input type="checkbox" id="setting-tolerance-type" />
            <span>Show Tolerance Type (Linear/GD&T/Float)</span>
          </label>
          <label class="setting-toggle">
            <input type="checkbox" id="setting-float-shifted" />
            <span>Show Float Shifted</span>
          </label>
        </div>
        <div class="table-actions">
          <button value="cancel" class="secondary">Close</button>
        </div>
      </form>
    </dialog>

    <dialog id="notes-dialog">
      <form method="dialog">
        <h3>Notes</h3>
        <label>
          <textarea id="notes-textarea" rows="8" placeholder="Enter notes here..."></textarea>
        </label>
        <div class="table-actions">
          <button type="button" id="notes-ok-btn">OK</button>
          <button value="cancel" class="secondary">Cancel</button>
        </div>
      </form>
    </dialog>

    <dialog id="source-dialog">
      <form method="dialog">
        <h3>Source Image</h3>
        <div class="source-container">
          <div class="source-upload-area" id="source-upload-area">
            <input type="file" id="source-file-input" accept="image/*" style="display: none;">
            <div class="upload-placeholder" id="upload-placeholder">
              <p>Drop image here, paste from clipboard, or click to upload</p>
              <button type="button" class="secondary" id="source-upload-btn">Choose File</button>
            </div>
            <div class="source-image-wrapper" id="source-image-wrapper" style="display: none;">
              <img id="source-image" alt="Source image">
              <canvas id="source-canvas"></canvas>
            </div>
          </div>
          <div class="source-actions">
            <button type="button" class="secondary" id="source-remove-btn" style="display: none;">Remove Image</button>
          </div>
        </div>
        <div class="table-actions">
          <button type="button" id="source-ok-btn">OK</button>
          <button value="cancel" class="secondary">Cancel</button>
        </div>
      </form>
    </dialog>

    <dialog id="analysis-setup-dialog">
      <form method="dialog">
        <h3>Analysis Setup</h3>
        
        <div class="form-section">
          <h4>Metadata</h4>
          <label>
            Analysis Title
            <input type="text" id="analysis-title" placeholder="Enter analysis title">
          </label>
          <label>
            Project
            <input type="text" id="analysis-project" placeholder="Enter project name">
          </label>
          <label>
            Part/Assembly Nr
            <input type="text" id="analysis-part-nr" placeholder="Enter part/assembly number">
          </label>
          <label>
            Analyst Name/ID
            <input type="text" id="analysis-analyst" placeholder="Enter analyst name or ID">
          </label>
          <label>
            Creation Date
            <input type="date" id="analysis-creation-date">
          </label>
        </div>

        <div class="form-section">
          <h4>Critical Requirement</h4>
          <label>
            Critical Feature/Gap Measured
            <input type="text" id="analysis-critical-feature" placeholder="Enter critical feature or gap">
          </label>
          <label>
            Nominal Target Value
            <input type="number" step="0.001" id="analysis-nominal-target" placeholder="Enter nominal target value">
          </label>
          <label>
            Lower Specification Limit (LSL)
            <input type="number" step="0.001" id="analysis-lsl" placeholder="Enter LSL">
          </label>
          <label>
            Upper Specification Limit (USL)
            <input type="number" step="0.001" id="analysis-usl" placeholder="Enter USL">
          </label>
          <label>
            Acceptance Criteria
            <select id="analysis-acceptance-criteria">
              <!-- Options will be populated dynamically -->
            </select>
          </label>
        </div>

        <div class="form-section">
          <h4>Assumptions Context</h4>
          <label>
            Functional Description / Notes
            <textarea id="analysis-functional-description" rows="4" placeholder="Enter functional description or notes"></textarea>
          </label>
        </div>

        <div class="table-actions">
          <button type="button" id="analysis-setup-ok-btn">OK</button>
          <button value="cancel" class="secondary">Cancel</button>
        </div>
      </form>
    </dialog>

    <script type="module" src="js/main.js"></script>
  </body>
</html>

